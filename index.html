<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Поиск по базе (Лист1) — UgraRemKomp</title>
<style>
:root{--bg:#f6f7f9;--card:#fff;--line:#e5e7eb;--text:#111827;--muted:#6b7280;--brand:#19c37d}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif}
.wrap{max-width:1100px;margin:0 auto;padding:18px}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
input[type="text"],select{padding:10px 12px;border:1px solid var(--line);border-radius:10px;font-size:16px}
input[type="text"]{flex:1}
.btn{padding:10px 14px;border-radius:10px;background:var(--brand);border:1px solid var(--brand);color:#fff;font-weight:700;cursor:pointer}
.btn.ghost{background:#fff;color:#111;border-color:var(--line)}
.small{color:var(--muted);font-size:13px}
.kv{display:flex;gap:12px;flex-wrap:wrap}
.kv>*{white-space:nowrap}
.table{margin-top:12px;background:var(--card);border:1px solid var(--line);border-radius:12px;overflow:auto}
.table table{width:100%;border-collapse:collapse}
.table th,.table td{padding:10px;border-bottom:1px solid var(--line);vertical-align:top}
.table th{background:#fafafa;position:sticky;top:0;z-index:1;user-select:none;cursor:pointer}
.table th .dir{opacity:.6;margin-left:6px}
mark{background:#fff59d}
.pager{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:8px}
.pager .right{display:flex;gap:8px;align-items:center}
.err{background:#fee2e2;color:#991b1b;border:1px solid #fecaca;padding:10px;border-radius:10px;margin-top:10px;display:none}
.ok{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0;padding:10px;border-radius:10px;margin-top:10px;display:none}
.copy{background:#111;border-color:#111}
.hidden-col{opacity:.5}
@media (max-width:640px){ .wrap{padding:12px} input[type="text"]{font-size:15px} }
</style>
</head>
<body>
<div class="wrap">
  <h1>Поиск по базе (Лист1)</h1>
  <div class="card">
    <div class="row">
      <input id="q" type="text" placeholder="Ищите по словам, числам, ссылкам — по всем колонкам" autocomplete="off">
      <select id="per">
        <option value="25">25 на странице</option>
        <option value="50" selected>50 на странице</option>
        <option value="100">100 на странице</option>
      </select>
      <button id="share" class="btn copy" title="Скопировать ссылку с запросом" style="display:none">Скопировать ссылку</button>
      <button id="export" class="btn ghost" title="Скачать результаты CSV">Экспорт CSV</button>
    </div>
    <div class="kv small">
      <div id="meta">Загружаю…</div>
      <div id="filterInfo" class="small"></div>
    </div>
    <div id="err" class="err"></div>
    <div id="ok" class="ok"></div>
  </div>

  <div class="kv small" id="colToggles" style="margin:10px 0"></div>

  <div id="box" class="table" style="display:none"></div>
  <div id="pager" class="pager" style="display:none">
    <div class="left small" id="pageinfo"></div>
    <div class="right">
      <button id="prev" class="btn ghost">Назад</button>
      <button id="next" class="btn">Вперёд</button>
    </div>
  </div>
</div>

<script>
// ===== ВАША ПУБЛИЧНАЯ CSV‑ССЫЛКА (Лист1) =====
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ-WdbNW6jAX7FGPWKKeWGwqhUTu9dGtXvRir6JYdZ8HmibpNaLt26X25NcrWDXf5q_hZax2jeuSeEf/pub?gid=0&single=true&output=csv";
// ============================================

// Утилиты
function parseCSV(text){
  const first = text.split(/\r?\n/,1)[0]||"";
  const sep = (first.split(';').length-1) > (first.split(',').length-1) ? ';' : ',';
  const rows=[], row=[], pushRow=()=>{ if(row.length) rows.push(row.splice(0)); };
  let cell="", q=false;
  for(let i=0;i<text.length;i++){
    const ch=text[i];
    if(q){ if(ch=='"'){ if(text[i+1]=='"'){cell+='"';i++;} else q=false; } else cell+=ch; continue; }
    if(ch=='"'){ q=true; continue; }
    if(ch==sep){ row.push(cell); cell=""; continue; }
    if(ch=='\n'){ row.push(cell); cell=""; pushRow(); continue; }
    if(ch=='\r'){ continue; }
    cell+=ch;
  }
  if(cell!==""||row.length){ row.push(cell); pushRow(); }
  return rows.filter(r=>r.some(c=>String(c).trim()!==""));
}
const norm = s => String(s||"").toLowerCase().replaceAll('ё','е');
const escapeHTML = s => String(s).replace(/[&<>\"]/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m]));
const urlify = s => { const v=String(s||"").trim(); const m=v.match(/^(https?:\/\/[^\s]+)$/i); return m?`<a href="${escapeHTML(v)}" target="_blank" rel="noopener">${escapeHTML(v)}</a>`:escapeHTML(v); };
const mark = (text, q) => { if(!q) return urlify(text); try{ const re=new RegExp("("+q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+")","ig"); return urlify(text).replace(re,'<mark>$1</mark>'); }catch{ return urlify(text); } };

// Данные
let HEAD=[], DATA=[], VIEW=[], PAGE=1, PER=50, SORT_COL=-1, SORT_DIR=1, HIDDEN={};

async function fetchCSV(url){
  const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(),12000);
  try{
    const res=await fetch(url,{cache:'no-store',signal:ctrl.signal});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const txt=await res.text();
    if(!txt.trim()) throw new Error('Пустой CSV');
    return parseCSV(txt);
  } finally{ clearTimeout(t); }
}

function detectNum(v){ const n = parseFloat(String(v).replace(/\s/g,'')); return !Number.isNaN(n) && isFinite(n); }

function sortView(){
  if(SORT_COL<0) return;
  VIEW.sort((a,b)=>{
    const va=a[SORT_COL]??'', vb=b[SORT_COL]??'';
    const aNum=detectNum(va), bNum=detectNum(vb);
    if(aNum && bNum){ return (parseFloat(va)-parseFloat(vb))*SORT_DIR; }
    return String(va).localeCompare(String(vb),'ru',{numeric:true})*SORT_DIR;
  });
}

function renderToggles(){
  const ct=document.getElementById('colToggles');
  ct.innerHTML = HEAD.map((h,i)=>{
    const id='col'+i; const checked = HIDDEN[i]?'' : 'checked';
    return `<label class="small"><input type="checkbox" id="${id}" ${checked}> ${escapeHTML(h)}</label>`;
  }).join(' \u00A0 ');
  HEAD.forEach((_,i)=>{
    const id='col'+i; const el=document.getElementById(id); if(!el) return;
    el.addEventListener('change',()=>{ HIDDEN[i]=!el.checked; render(); });
  });
}

function render(){
  const box=document.getElementById('box');
  const q=document.getElementById('q').value.trim();
  if(!VIEW.length){ box.style.display='none'; document.getElementById('pager').style.display='none'; document.getElementById('pageinfo').textContent=''; return; }
  sortView();
  const start=(PAGE-1)*PER, end=Math.min(start+PER, VIEW.length);
  const rows=VIEW.slice(start,end);
  let thead = '<tr>'+HEAD.map((h,i)=>`<th data-i="${i}" title="Сортировка">${escapeHTML(h)}${SORT_COL===i?`<span class="dir">${SORT_DIR>0?'▲':'▼'}</span>`:''}</th>`).join('')+'</tr>';
  let tbody = rows.map(r=>'<tr>'+r.map((c,i)=>`<td style="${HIDDEN[i]?'display:none':''}">${mark(c,q)}</td>`).join('')+'</tr>').join('');
  // применим скрытие к заголовкам
  thead = thead.replace(/<th data-i="(\d+)"/g,(m,d)=>`<th data-i="${d}" style="${HIDDEN[+d]?'display:none':''}"`);
  box.innerHTML = `<div class="table"><table><thead>${thead}</thead><tbody>${tbody}</tbody></table></div>`;
  box.style.display='block';
  // вешаем sort
  box.querySelectorAll('th').forEach(th=>{
    th.addEventListener('click',()=>{ const i=+th.getAttribute('data-i'); if(Number.isNaN(i)) return; if(SORT_COL===i) SORT_DIR*=-1; else { SORT_COL=i; SORT_DIR=1; } PAGE=1; render(); });
  });
  // pager
  const pager=document.getElementById('pager');
  pager.style.display = VIEW.length>PER ? 'flex' : 'none';
  document.getElementById('pageinfo').textContent = `${start+1}–${end} из ${VIEW.length}`;
  document.getElementById('prev').disabled = PAGE<=1;
  document.getElementById('next').disabled = end>=VIEW.length;
}

function applyFilter(){
  const q = norm(document.getElementById('q').value.trim());
  if(!q){ VIEW = DATA.slice(); PAGE=1; render(); document.getElementById('ok').textContent='Загружено строк: '+VIEW.length; document.getElementById('ok').style.display='block'; return; }
  VIEW = DATA.filter(row => row.some(c => norm(c).includes(q)));
  PAGE=1; render();
  const ok=document.getElementById('ok'); ok.textContent=`Найдено: ${VIEW.length}`; ok.style.display='block';
}

function setShare(){
  const val=document.getElementById('q').value.trim();
  const url=new URL(location.href); if(val) url.searchParams.set('q', val); else url.searchParams.delete('q');
  history.replaceState(null,'',url);
  document.getElementById('share').style.display = val?'' : 'none';
}

function exportCSV(){
  if(!VIEW.length) return;
  const out=[HEAD].concat(VIEW).map(r=>r.map(v=>{
    const s=String(v??'');
    return /[",\n;]/.test(s) ? '"'+s.replace(/"/g,'""')+'"' : s;
  }).join(',')).join('\n');
  const blob=new Blob([out],{type:'text/csv;charset=utf-8'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='search-export.csv'; a.click(); URL.revokeObjectURL(a.href);
}

async function init(){
  const err=document.getElementById('err'); const ok=document.getElementById('ok');
  err.style.display='none'; ok.style.display='none';
  try{
    const rows = await fetchCSV(CSV_URL);
    HEAD = rows[0]||[]; DATA = rows.slice(1); VIEW = DATA.slice();
    document.getElementById('meta').textContent = `Источник: Google Sheets CSV · Колонок: ${HEAD.length} · Строк: ${DATA.length}`;
    renderToggles();
    // авто из ?q=
    const q = new URL(location.href).searchParams.get('q') || '';
    if(q){ document.getElementById('q').value=q; }
    setShare(); render(); if(q) applyFilter(); else { ok.textContent='Загружено строк: '+DATA.length; ok.style.display='block'; }
  }catch(e){ err.textContent = 'Ошибка: '+(e.message||e)+'. Проверьте публикацию CSV и доступ по ссылке.'; err.style.display='block'; }
}

// События
let deb; document.getElementById('q').addEventListener('input', ()=>{ clearTimeout(deb); deb=setTimeout(()=>{ setShare(); applyFilter(); }, 200); });

document.getElementById('share').addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(location.href); const ok=document.getElementById('ok'); ok.textContent='Ссылка скопирована'; ok.style.display='block'; }catch{} });

document.getElementById('prev').addEventListener('click', ()=>{ if(PAGE>1){ PAGE--; render(); } });

document.getElementById('next').addEventListener('click', ()=>{ const max=Math.ceil(VIEW.length/PER); if(PAGE<max){ PAGE++; render(); } });

document.getElementById('per').addEventListener('change', (e)=>{ PER=+e.target.value||50; PAGE=1; render(); });

document.getElementById('export').addEventListener('click', exportCSV);

init();
</script>
</body>
</html>
